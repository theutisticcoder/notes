<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notefy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.5/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=61e149774ef749af85e101d235490606"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.5/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .cornell-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            grid-template-rows: auto 1fr auto;
            gap: 1px;
            background: #e5e7eb;
            min-height: 400px;
            overflow-y: scroll;
        }

        .flex-1 {
            overflow-y: auto;
        }

        .cue-column {
            grid-column: 1;
            grid-row: 2;
            overflow-y: visible;
        }

        .notes-column {
            grid-column: 2;
            grid-row: 2;
            overflow-y: visible;
        }

        .summary-section {
            grid-column: 1 / -1;
            grid-row: 3;
            overflow-y: visible;
        }

        .header-section {
            grid-column: 1 / -1;
            grid-row: 1;
            overflow-y: visible;
        }

        textarea {
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Notefy</h1>
            <button onclick="addClass()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                + Add Class
            </button>
            <button onclick="logout()"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                Sign Out
            </button>
        </div>

        <div id="classesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

        <div id="emptyState" class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üìö</div>
            <h3 class="text-xl font-medium mb-2">No classes yet</h3>
            <p>Click "Add Class" to create your first Cornell notes</p>
        </div>
    </div>

    <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 mx-4">
            <h3 class="text-lg font-semibold mb-4">Add New Class</h3>
            <input type="text" id="classNameInput" placeholder="Class name (e.g., Biology 101)"
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div class="flex gap-3">
                <button onclick="saveClass()"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">
                    Create Class
                </button>
                <button onclick="closeModal()"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="deleteClassModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 mx-4">
            <h3 class="text-lg font-semibold mb-4 text-red-600">Delete Class</h3>
            <p class="text-gray-700 mb-4">Are you sure you want to delete "<span id="deleteClassName"></span>" and all
                its notes? This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="confirmDeleteClass()"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium">
                    Delete Class
                </button>
                <button onclick="closeDeleteClassModal()"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="deleteNoteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 mx-4">
            <h3 class="text-lg font-semibold mb-4 text-red-600">Delete Note</h3>
            <p class="text-gray-700 mb-4">Are you sure you want to delete "<span id="deleteNoteName"></span>"? This
                action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="confirmDeleteNote()"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium">
                    Delete Note
                </button>
                <button onclick="closeDeleteNoteModal()"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full h-full m-4 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="noteModalTitle" class="text-lg font-semibold">Taking Notes</h3>
                <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="flex-1 p-4">
                <div class="cornell-grid h-full">
                    <div class="header-section bg-white p-4">
                        <input type="text" id="noteTitle" placeholder="Note title..."
                            class="w-full text-lg font-medium border-none outline-none bg-transparent">
                        <input type="text" id="noteDate" placeholder="Date..."
                            class="w-full text-sm text-gray-600 border-none outline-none bg-transparent mt-1">
                    </div>

                    <div class="cue-column bg-white p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-700">Cues & Questions</h4>
                            <button onclick="addCueBullet()" class="text-blue-600 hover:text-blue-700 text-sm">+
                                Bullet</button>
                        </div>
                        <div id="cueContent" class="space-y-2">
                        </div>
                    </div>

                    <div class="notes-column bg-white p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-700">Notes</h4>
                            <button onclick="addNoteBullet()" class="text-blue-600 hover:text-blue-700 text-sm">+
                                Bullet</button>
                        </div>
                        <div id="notesContent" class="space-y-2">
                        </div>
                    </div>

                    <div class="summary-section bg-white p-4">
                        <h4 class="font-medium text-gray-700 mb-3">Summary</h4>
                        <textarea id="summaryContent" placeholder="Write a summary of your notes..."
                            class="w-full h-20 resize-none border-none outline-none bg-transparent"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;

        var classes = [];
        var secret;

        var login;

        var id;
        const supa = createClient('https://mxxrkkvduantjngmafjc.supabase.co', "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14eHJra3ZkdWFudGpuZ21hZmpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDg1NTMsImV4cCI6MjA3MjM4NDU1M30.zgcbIIFYWg897oRzw7xonwUqVslQp0HEKIYEz4zmaBs");
        var user;
        function logout() {
            localStorage.removeItem("username")
            localStorage.removeItem("password")
            location.reload();
        }
        setTimeout(async () => {

            if (localStorage.getItem("username")) {
                if (localStorage.getItem("secret")) {
                    secret = localStorage.getItem("secret")
                }
                else {
                    secret = prompt("Choose a passphrase to encrypt your data. You CANNOT change this, so remember it and make it secure. Just in case, it will be stored locally UNTIL you sign out");
                    localStorage.setItem("secret", secret)
                }
                const { data, error } = await supa.auth.signInWithPassword({
                    email: localStorage.getItem("username"),
                    password: localStorage.getItem("password"),
                })
                user = await supa.auth.getUser()
                classes = (await supa
                    .from('notes')
                    .select('notes')
                    .eq("id", user.data.user.id)
                ).data[0].notes;
                try {
                    classes = JSON.parse(CryptoJS.AES.decrypt(classes, secret).toString(CryptoJS.enc.Utf8));
                }
                catch {
                    classes = JSON.parse(classes);

                }


                await renderClasses();
            }
            else {

                login = await Swal.fire({
                    title: 'Login Form',
                    html: `
    <input type="email" id="username" class="swal2-input" placeholder="Email">
    <input type="password" id="password" class="swal2-input" placeholder="Password">
    <input type="checkbox" id="save" class="swal2-input"><p>Save Login?</p>
  `,
                    confirmButtonText: 'Sign in',
                    focusConfirm: false,
                    didOpen: () => {
                        const popup = Swal.getPopup()
                        usernameInput = popup.querySelector('#username')
                        passwordInput = popup.querySelector('#password')
                        usernameInput.onkeyup = (event) => event.key === 'Enter' && Swal.clickConfirm()
                        passwordInput.onkeyup = (event) => event.key === 'Enter' && Swal.clickConfirm()
                    },
                    preConfirm: () => {
                        if (document.querySelector("#save").checked) {
                            localStorage.setItem("username", usernameInput.value)
                            localStorage.setItem("password", passwordInput.value)
                        }
                        const username = usernameInput.value
                        const password = passwordInput.value
                        if (!username || !password) {
                            Swal.showValidationMessage(`Please enter username and password`)
                        }
                        return { username, password }
                    },
                })
                const { data, error } = await supa.auth.signInWithPassword({
                    email: login.value.username,
                    password: login.value.password,
                })

                if (error) {
                    const { data, error } = await supa.auth.signUp({
                        email: login.value.username,
                        password: login.value.password,
                    })
                    user = await supa.auth.getUser()
                    secret = prompt("Choose a passphrase to encrypt your data. You CANNOT change this, so remember it and make it secure. Just in case, it will be stored locally");
                    localStorage.setItem("secret", secret);
                }
                else {
                    if (localStorage.getItem("secret")) {
                        secret = localStorage.getItem("secret")
                    }
                    else {
                        secret = prompt("Choose a passphrase to encrypt your data. You CANNOT change this, so remember it and make it secure. Just in case, it will be stored locally UNTIL you sign out");
                        localStorage.setItem("secret", secret)
                    }

                    user = await supa.auth.getUser()
                    classes = (await supa
                        .from('notes')
                        .select('notes')
                        .eq("id", user.data.user.id)
                    ).data[0].notes;
                    try {
                        classes = JSON.parse(CryptoJS.AES.decrypt(classes, secret).toString(CryptoJS.enc.Utf8));
                    }
                    catch {
                        classes = JSON.parse(classes);

                    }


                    await renderClasses();


                }
            }

        }, 10)


        function setupAutoresize() {
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('input', e => {
                    e.target.style.height = 'auto';
                    e.target.style.height = e.target.scrollHeight + 'px';
                    autoSave(); // Call autoSave after resize
                });
                // Initial resize on load
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
        }
        let currentClassId = null;
        let currentNoteId = null;
        let deleteClassId = null;
        let deleteNoteId = null;

        // New variables for audio recording
        let recognition;
        let isTranscribing = false;

        async function saveClasses() {
            const { data, error } = await supa
                .from('notes')
                .upsert([{ notes: CryptoJS.AES.encrypt(JSON.stringify(classes), secret).toString(), id: user.data.user.id }])
                .select();

            if (error) {
                console.error('Error saving classes:', error);
            }
        }

        function addClass() {
            document.getElementById('classModal').classList.remove('hidden');
            document.getElementById('classModal').classList.add('flex');
            document.getElementById('classNameInput').focus();
        }

        function closeModal() {
            document.getElementById('classModal').classList.add('hidden');
            document.getElementById('classModal').classList.remove('flex');
            document.getElementById('classNameInput').value = '';
        }

        async function saveClass() {
            const className = document.getElementById('classNameInput').value.trim();
            if (!className) return;

            const newClass = {
                id: Date.now(),
                name: className,
                notes: []
            };

            classes.push(newClass);
            await saveClasses();
            await renderClasses();
            closeModal();
        }

        async function deleteClass(classId) {
            deleteClassId = classId;
            const classObj = classes.find(c => c.id === classId);
            document.getElementById('deleteClassName').textContent = classObj.name;
            document.getElementById('deleteClassModal').classList.remove('hidden');
            document.getElementById('deleteClassModal').classList.add('flex');
        }

        function closeDeleteClassModal() {
            document.getElementById('deleteClassModal').classList.add('hidden');
            document.getElementById('deleteClassModal').classList.remove('flex');
            deleteClassId = null;
        }

        async function confirmDeleteClass() {
            if (deleteClassId) {
                classes = classes.filter(c => c.id !== deleteClassId);
                await saveClasses();
                await renderClasses();
                closeDeleteClassModal();
            }
        }

        function openNotes(classId) {
            currentClassId = classId;
            const classObj = classes.find(c => c.id === classId);
            showNotesView(classObj);
        }
        var calcs = [];
        function addgraph() {
            const notesContent = document.getElementById('notesContent');
            var elt = document.createElement("div");
            elt.style.height = "200px";
            elt.style.width = "100%";
            notesContent.appendChild(elt);
            var calculator = Desmos.GraphingCalculator(elt);

            var del = document.createElement("button");
            del.innerHTML = "Delete Graph"
            del.style.background = "maroon"
            del.style.color = "white"
            del.onclick = () => {
                elt.remove();
                del.parentNode.removeChild(del);
            }
            notesContent.appendChild(del);
            const classObj = classes.find(c => c.id === currentClassId);
            if (!classObj) return;

            const note = classObj.notes.find(n => n.id === currentNoteId);
            if (!note) return;

            calcs.push({ id: note.id, calculator: calculator })
        }
        function loadgraph(data) {
            const notesContent = document.getElementById('notesContent');
            var elt = document.createElement("div");
            elt.style.height = "200px";
            elt.style.width = "100%";
            notesContent.appendChild(elt);
            var calculator = Desmos.GraphingCalculator(elt);
            calculator.setState(data)
            var del = document.createElement("button");
            del.innerHTML = "Delete Graph"
            del.style.background = "maroon"
            del.style.color = "white"
            del.onclick = () => {
                elt.remove();
                del.parentNode.removeChild(del);
            }
            notesContent.appendChild(del);
        }
        function showNotesView(classObj) {
            const noteModal = document.getElementById('noteModal');
            noteModal.innerHTML = `
                <div class="bg-white rounded-lg w-full h-full m-4 flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">${classObj.name} - Notes</h3>
                        <div class="flex gap-2">
                            <button onclick="exportClassToPDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                üìÑ Export PDF
                            </button>
                            <button onclick="createNewNote()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                                + New Note
                            </button>
                            <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 p-4 overflow-y-auto">
                        <div id="notesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderNotesList(classObj)}
                        </div>
                        
                        <div id="emptyNotes" class="text-center py-12 text-gray-500 ${classObj.notes && classObj.notes.length > 0 ? 'hidden' : ''}">
                            <div class="text-4xl mb-4">üìù</div>
                            <h3 class="text-lg font-medium mb-2">No notes yet</h3>
                            <p>Click "New Note" to create your first Cornell note</p>
                        </div>
                    </div>
                </div>
            `;

            noteModal.classList.remove('hidden');
            noteModal.classList.add('flex');
        }

        function renderNotesList(classObj) {
            if (!classObj.notes || classObj.notes.length === 0) return '';

            return classObj.notes.map(note => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-800 truncate">${note.title || 'Untitled Note'}</h4>
                        <button  class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg onclick="deleteNote(${note.id})" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 102 0v3a1 1 0 11-2 0V9zm4 0a1 1 0 10-2 0v3a1 1 0 102 0V9z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${note.date || ''}</p>
                    <div class="text-xs text-gray-500 mb-3">
                        ${note.cues ? note.cues.length : 0} cues ‚Ä¢ ${note.notes ? note.notes.length : 0} notes
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editNote(${note.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-sm font-medium">
                            Open Note
                        </button>
                        <button onclick="event.stopPropagation(); exportNoteToPDF(${note.id})" class="bg-green-600 hover:bg-green-700 text-white py-2 px-2 rounded text-sm font-medium" title="Export to PDF">
                            üìÑ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.add('hidden');
            document.getElementById('noteModal').classList.remove('flex');
        }

        async function createNewNote() {
            const newNote = {
                id: Date.now(),
                title: '',
                date: new Date().toLocaleDateString(),
                cues: [],
                notes: [],
                graphs: [],
                summary: []
            };

            const classObj = classes.find(c => c.id === currentClassId);
            if (!classObj.notes) classObj.notes = [];
            classObj.notes.push(newNote);
            await saveClasses();

            editNote(newNote.id);
        }

        function editNote(noteId) {
            const classObj = classes.find(c => c.id === currentClassId);
            const note = classObj.notes.find(n => n.id === noteId);

            showNoteEditor(note);
        }

        async function deleteNote(noteId) {
            deleteNoteId = noteId;
            const classObj = classes.find(c => c.id === currentClassId);
            const note = classObj.notes.find(n => n.id === noteId);
            document.getElementById('deleteNoteName').textContent = note.title || 'Untitled Note';
            document.getElementById('deleteNoteModal').classList.remove('hidden');
            document.getElementById('deleteNoteModal').classList.add('flex');
        }

        function closeDeleteNoteModal() {
            document.getElementById('deleteNoteModal').classList.add('hidden');
            document.getElementById('deleteNoteModal').classList.remove('flex');
            deleteNoteId = null;
        }

        async function confirmDeleteNote() {
            if (deleteNoteId && currentClassId) {
                const classObj = classes.find(c => c.id === currentClassId);
                classObj.notes = classObj.notes.filter(n => n.id !== deleteNoteId);
                await saveClasses();
                showNotesView(classObj);
                closeDeleteNoteModal();
            }
        }

        function showNoteEditor(note) {
            const noteModal = document.getElementById('noteModal');
            noteModal.innerHTML = `
                <div class="bg-white rounded-lg w-full h-full m-4 flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Editing Note</h3>
                        <div class="flex gap-2">
                            <button onclick="backToNotesList()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                                ‚Üê Back
                            </button>
                            <button id="transcribeButton" onclick="toggleTranscription()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                                üéôÔ∏è Start Transcription
                            </button>
                            <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 p-4">
                        <div class="cornell-grid h-full">
                            <div class="header-section bg-white p-4">
                                <input type="text" id="noteTitle" placeholder="Note title..." value="${note.title || ''}"
                                       class="w-full text-lg font-medium border-none outline-none bg-transparent">
                                <input type="text" id="noteDate" placeholder="Date..." value="${note.date || ''}"
                                       class="w-full text-sm text-gray-600 border-none outline-none bg-transparent mt-1">
                            </div>
                            
                            <div class="cue-column bg-white p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-700">Cues & Questions</h4>
                                    <button onclick="addCueBullet()" class="text-blue-600 hover:text-blue-700 text-sm">+ Bullet</button>
                                </div>
                                <div id="cueContent" class="space-y-2">
                                    ${note.cues.map(cue => `
                                        <div class="flex items-start gap-2">
                                            <span class="text-blue-600 mt-1">‚Ä¢</span>
                                            <textarea id="editor" class="border-none outline-none bg-transparent" onchange="autoSave()">${cue}</textarea>
                                            <button onclick="this.parentElement.remove(); autoSave();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="notes-column bg-white p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-700">Notes</h4>
                                    <button onclick="addNoteBullet()" class="text-blue-600 hover:text-blue-700 text-sm">+ Bullet</button>
                                    <button onclick="addgraph()" class="text-blue-600 hover:text-blue-700 text-sm">+ Graph</button>
                                </div>
                                <div id="notesContent" class="space-y-2">
                                    ${note.notes.map(noteText => `
                                        <div class="flex items-start gap-2">
                                            <span class="text-gray-600 mt-1">‚Ä¢</span>
                                            <textarea id="editor" class=" border-none outline-none bg-transparent" onchange="autoSave()">${noteText}</textarea>
                                            <button onclick="this.parentElement.remove(); autoSave();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="summary-section bg-white p-4">
                                <h4 class="font-medium text-gray-700 mb-3">Summary</h4>
                                <textarea id="summaryContent" placeholder="Write a summary of your notes..." 
                                          class="w-full h-20 resize-none border-none outline-none bg-transparent">${note.summary || ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if (note.graphs) {
                note.graphs.forEach(state => {
                    loadgraph(state);
                });
            }
            else {
                note.graphs = [];
            }
            currentNoteId = note.id;
ClassicEditor
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.create( document.querySelector( '#editor' ) )
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.catch( error => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†console.error( error );
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†} );

        }

        async function backToNotesList() {
            await saveCurrentNote();
            const classObj = classes.find(c => c.id === currentClassId);
            showNotesView(classObj);
        }

        function addCueBullet() {
            const cueContent = document.getElementById('cueContent');
            const bullet = document.createElement('div');
            bullet.className = 'flex items-start gap-2';
            bullet.innerHTML = `
                <span class="text-blue-600 mt-1">‚Ä¢</span>
                <textarea id="editor" placeholder="Add a cue or question..." 
                       class="border-none outline-none bg-transparent" 
                       onchange="autoSave()"></textarea>
                <button onclick="this.parentElement.remove(); autoSave();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
            `;
            ClassicEditor
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.create( document.querySelector( '#editor' ) )
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.catch( error => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†console.error( error );
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†} );

            cueContent.appendChild(bullet);
            bullet.querySelector('textarea').focus();
        }

        function addNoteBullet() {
            const notesContent = document.getElementById('notesContent');
            const bullet = document.createElement('div');
            bullet.className = 'flex items-start gap-2';
            bullet.innerHTML = `
                <span class="text-gray-600 mt-1">‚Ä¢</span>
                <textarea id="editor" placeholder="Add a note..." 
                       class=" border-none outline-none bg-transparent" 
                       onchange="autoSave()"></textarea>
                <button onclick="this.parentElement.remove(); autoSave();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
            `;

            notesContent.appendChild(bullet);
            ClassicEditor
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.create( document.querySelector( '#editor' ) )
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†.catch( error => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†console.error( error );
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†} );

            bullet.querySelector('textarea').focus();
            setupAutoresize();
        }

        function autoSave() {
            if (currentClassId) {
                setTimeout(saveCurrentNote, 100);
            }
        }

        async function saveCurrentNote() {
            if (!currentClassId || !currentNoteId) return;

            const classObj = classes.find(c => c.id === currentClassId);
            if (!classObj) return;

            const note = classObj.notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const titleEl = document.getElementById('noteTitle');
            const dateEl = document.getElementById('noteDate');
            const summaryEl = document.getElementById('summaryContent');

            if (titleEl) note.title = titleEl.value;
            if (dateEl) note.date = dateEl.value;
            if (summaryEl) note.summary = summaryEl.value;

            const cueTextareas = document.querySelectorAll('#cueContent textarea');
            const noteTextareas = document.querySelectorAll('#notesContent textarea');
            const graphs = document.querySelectorAll('#notesContent div');


            if (cueTextareas.length > 0) {
                note.cues = Array.from(cueTextareas).map(textarea => textarea.value).filter(v => v.trim());
            }

            if (noteTextareas.length > 0) {
                note.notes = Array.from(noteTextareas).map(textarea => textarea.value).filter(v => v.trim());
            }
            if (graphs.length > 0) {
                note.graphs = [];
                calcs.forEach(calc => {
                    if (calc.id === currentNoteId) {
                        note.graphs.push(calc.calculator.getState())
                    }
                })
            }

            await saveClasses();
        }

        async function renderClasses() {
            const grid = document.getElementById('classesGrid');
            const emptyState = document.getElementById('emptyState');


            if (classes.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = classes.map(classObj => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">${classObj.name}</h3>
                        <button onclick="event.stopPropagation(); deleteClass(${classObj.id})" 
                                class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 102 0v3a1 1 0 11-2 0V9zm4 0a1 1 0 10-2 0v3a1 1 0 102 0V9z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-4">
                        ${classObj.notes && classObj.notes.length > 0 ?
                    `<div class="flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                ${classObj.notes.length} note${classObj.notes.length === 1 ? '' : 's'}
                            </div>` :
                    `<div class="flex items-center gap-2">
                                <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                No notes yet
                            </div>`
                }
                    </div>
                    
                    <button onclick="openNotes(${classObj.id})" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        Open Notes
                    </button>
                </div>
            `).join('');
        }

        // Auto-save on input changes
        document.addEventListener('input', (e) => {
            if (e.target.closest('#noteModal')) {
                autoSave();
            }
        });

        // Handle Enter key for adding bullets
        

        // Speech Recognition Functions
        function toggleTranscription() {
            const transcribeButton = document.getElementById('transcribeButton');

            if (isTranscribing) {
                // Stop transcription
                recognition.stop();
                isTranscribing = false;
                transcribeButton.textContent = 'üéôÔ∏è Start Transcription';
                transcribeButton.classList.replace('bg-red-600', 'bg-purple-600');
            } else {
                // Check for browser support
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("Your browser does not support the Web Speech API. Please try Google Chrome or Microsoft Edge.");
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                let finalTranscript = '';

                recognition.onstart = () => {
                    isTranscribing = true;
                    transcribeButton.textContent = '‚èπÔ∏è Stop Transcription';
                    transcribeButton.classList.replace('bg-purple-600', 'bg-red-600');
                };

                recognition.onresult = event => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // Append the new text to a temporary text area for a smooth experience
                    const notesContent = document.getElementById('notesContent');
                    let tempInput = document.getElementById('interimTranscription');
                    if (!tempInput) {
                        tempInput = document.createElement('textarea');
                        tempInput.id = 'interimTranscription';
                        tempInput.readOnly = true;
                        tempInput.className = ' border-none outline-none bg-transparent text-gray-400 italic';
                        const bullet = document.createElement('div');
                        bullet.className = 'flex items-start gap-2';
                        bullet.innerHTML = `<span class="text-gray-600 mt-1">‚Ä¢</span>`;
                        bullet.appendChild(tempInput);
                        notesContent.appendChild(bullet);
                    }
                    tempInput.value = finalTranscript + interimTranscript;
                };
                recognition.onspeechend = () => {
                    recognition.start();
                }

                recognition.onend = async () => {
                    // When transcription ends, remove the interim input and save the final text
                    const notesContent = document.getElementById('notesContent');
                    const tempInput = document.getElementById('interimTranscription');
                    if (tempInput && finalTranscript.trim() !== '') {
                        const newNoteText = finalTranscript.trim();
                        tempInput.parentNode.remove();
                        addNoteBulletWithText(newNoteText);
                        await saveCurrentNote();
                    } else if (tempInput) {
                        tempInput.parentNode.remove();
                    }
                    isTranscribing = false;
                    transcribeButton.textContent = 'üéôÔ∏è Start Transcription';
                    transcribeButton.classList.replace('bg-red-600', 'bg-purple-600');
                };

                recognition.onerror = event => {
                    console.error('Speech recognition error:', event.error);
                    alert(`Speech recognition error: ${event.error}`);
                    isTranscribing = false;
                    transcribeButton.textContent = 'üéôÔ∏è Start Transcription';
                    transcribeButton.classList.replace('bg-red-600', 'bg-purple-600');
                };

                recognition.start();
            }
        }

        function addNoteBulletWithText(text) {
            const notesContent = document.getElementById('notesContent');
            const bullet = document.createElement('div');
            bullet.className = 'flex items-start gap-2';
            bullet.innerHTML = `
                <span class="text-gray-600 mt-1">‚Ä¢</span>
                <textarea class=" border-none outline-none bg-transparent" onchange="autoSave()">${text}</textarea>
                <button onclick="this.parentElement.remove(); autoSave();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
            `;
            notesContent.appendChild(bullet);
            bullet.querySelector('textarea').focus();
            setupAutoresize();
        }

        // PDF Export Functions
        function exportClassToPDF() {
            const classObj = classes.find(c => c.id === currentClassId);
            if (!classObj || !classObj.notes || classObj.notes.length === 0) {
                alert('No notes to export in this class.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();


            classObj.notes.forEach((note, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                } const doc = new jsPDF();

                // Header
                doc.setFontSize(18);
                doc.text(note.title || 'Untitled Note', 20, 30);

                doc.setFontSize(12);
                doc.text(`Class: ${classObj.name}`, 20, 45);
                doc.text(`Date: ${note.date || 'No date'}`, 20, 55);

                let yPosition = 75;

                // Cornell Note Layout
                doc.setFontSize(14);
                doc.text('Cornell Notes', 20, yPosition);
                yPosition += 15;

                // Draw Cornell layout lines
                doc.line(20, yPosition, 190, yPosition); // Top line
                doc.line(20, yPosition, 20, yPosition + 120); // Left line
                doc.line(70, yPosition, 70, yPosition + 90); // Cue column separator
                doc.line(190, yPosition, 190, yPosition + 120); // Right line
                doc.line(20, yPosition + 90, 190, yPosition + 90); // Summary separator
                doc.line(20, yPosition + 120, 190, yPosition + 120); // Bottom line

                // Cues section
                doc.setFontSize(10);
                doc.text('Cues & Questions', 22, yPosition + 8);

                let cueY = yPosition + 18;
                if (note.cues && note.cues.length > 0) {
                    note.cues.forEach(cue => {
                        if (cueY < yPosition + 85) {
                            const cueLines = doc.splitTextToSize(`‚Ä¢ ${cue}`, 45);
                            cueLines.forEach(line => {
                                if (cueY < yPosition + 85) {
                                    doc.text(line, 22, cueY);
                                    cueY += 5;
                                }
                            });
                        }
                    });
                }

                // Notes section
                doc.text('Notes', 72, yPosition + 8);

                let notesY = yPosition + 18;
                if (note.notes && note.notes.length > 0) {
                    note.notes.forEach(noteText => {
                        if (notesY < yPosition + 85) {
                            const noteLines = doc.splitTextToSize(`‚Ä¢ ${noteText}`, 115);
                            noteLines.forEach(line => {
                                if (notesY < yPosition + 85) {
                                    doc.text(line, 72, notesY);
                                    notesY += 5;
                                }
                            });
                        }
                    });
                }

                // Summary section
                doc.text('Summary', 22, yPosition + 98);

                if (note.summary && note.summary.trim()) {
                    const summaryLines = doc.splitTextToSize(note.summary, 165);
                    let summaryY = yPosition + 108;
                    summaryLines.forEach(line => {
                        if (summaryY < yPosition + 118) {
                            doc.text(line, 22, summaryY);
                            summaryY += 5;
                        }
                    });
                }

            });

            doc.save(`${classObj.name}_Notes.pdf`);
        }

        function exportNoteToPDF(noteId) {
            const classObj = classes.find(c => c.id === currentClassId);
            const note = classObj.notes.find(n => n.id === noteId);

            if (!note) {
                alert('Note not found.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.text(note.title || 'Untitled Note', 20, 30);

            doc.setFontSize(12);
            doc.text(`Class: ${classObj.name}`, 20, 45);
            doc.text(`Date: ${note.date || 'No date'}`, 20, 55);

            let yPosition = 75;

            // Cornell Note Layout
            doc.setFontSize(14);
            doc.text('Cornell Notes', 20, yPosition);
            yPosition += 15;

            // Draw Cornell layout lines
            doc.line(20, yPosition, 190, yPosition); // Top line
            doc.line(20, yPosition, 20, yPosition + 120); // Left line
            doc.line(70, yPosition, 70, yPosition + 90); // Cue column separator
            doc.line(190, yPosition, 190, yPosition + 120); // Right line
            doc.line(20, yPosition + 90, 190, yPosition + 90); // Summary separator
            doc.line(20, yPosition + 120, 190, yPosition + 120); // Bottom line

            // Cues section
            doc.setFontSize(10);
            doc.text('Cues & Questions', 22, yPosition + 8);

            let cueY = yPosition + 18;
            if (note.cues && note.cues.length > 0) {
                note.cues.forEach(cue => {
                    if (cueY < yPosition + 85) {
                        const cueLines = doc.splitTextToSize(`‚Ä¢ ${cue}`, 45);
                        cueLines.forEach(line => {
                            if (cueY < yPosition + 85) {
                                doc.text(line, 22, cueY);
                                cueY += 5;
                            }
                        });
                    }
                });
            }

            // Notes section
            doc.text('Notes', 72, yPosition + 8);

            let notesY = yPosition + 18;
            if (note.notes && note.notes.length > 0) {
                note.notes.forEach(noteText => {
                    if (notesY < yPosition + 85) {
                        const noteLines = doc.splitTextToSize(`‚Ä¢ ${noteText}`, 115);
                        noteLines.forEach(line => {
                            if (notesY < yPosition + 85) {
                                doc.text(line, 72, notesY);
                                notesY += 5;
                            }
                        });
                    }
                });
            }

            // Summary section
            doc.text('Summary', 22, yPosition + 98);

            if (note.summary && note.summary.trim()) {
                const summaryLines = doc.splitTextToSize(note.summary, 165);
                let summaryY = yPosition + 108;
                summaryLines.forEach(line => {
                    if (summaryY < yPosition + 118) {
                        doc.text(line, 22, summaryY);
                        summaryY += 5;
                    }
                });
            }

            const fileName = `${note.title || 'Note'}_${classObj.name}.pdf`;
            doc.save(fileName);
        }


    </script>
</body>

</html>